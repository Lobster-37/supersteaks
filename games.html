<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperSteaks.co.uk - Enter Now</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Using Inter font as requested */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f4f8; 
        }
        .nav-link:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.2); 
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header & Navigation - Indigo-800 theme -->
    <header class="bg-indigo-800 text-white shadow-xl">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-3xl font-extrabold tracking-widest text-yellow-400">SUPERSTEAKS.CO.UK</h1>
            
            <!-- Navigation Menu - 'Enter Now' is now the active link -->
            <nav class="mt-4 md:mt-0">
                <ul class="flex space-x-4 sm:space-x-6">
                    <li>
                        <a href="index.html" class="nav-link px-3 py-2 rounded-lg transition duration-300 hover:bg-indigo-700">Home</a>
                    </li>
                    <li>
                        <a href="contests.html" class="nav-link px-3 py-2 rounded-lg transition duration-300 hover:bg-indigo-700">Our Draws</a>
                    </li>
                    <li>
                        <!-- Active Link -->
                        <a href="games.html" class="nav-link px-3 py-2 rounded-lg transition duration-300 bg-indigo-700 hover:bg-indigo-600 font-semibold text-yellow-400 border-2 border-yellow-400">Enter Now</a>
                    </li>
                    <li>
                        <a href="rules.html" class="nav-link px-3 py-2 rounded-lg transition duration-300 hover:bg-indigo-700">How It Works</a>
                    </li>
                    <li>
                        <a href="contact.html" class="nav-link px-3 py-2 rounded-lg transition duration-300 hover:bg-indigo-700">Contact</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="container mx-auto px-4 py-12 flex-grow">
        <section class="text-center bg-white p-6 md:p-12 rounded-3xl shadow-2xl border-b-4 border-yellow-400">
            <h2 class="text-4xl md:text-5xl font-black text-indigo-900 mb-4 leading-tight">
                Current <span class="text-yellow-500">Free Draw</span>
            </h2>
            <p class="text-lg text-gray-700 max-w-4xl mx-auto mb-8">
                Ready for the fun? Click "Enter Draw" below to get your random team assignment!
            </p>

            <!-- Draw Card -->
            <div id="draw-card" class="max-w-xl mx-auto bg-indigo-50 p-8 rounded-2xl shadow-xl transition-all duration-500">
                <div id="loading-spinner">
                    <div class="text-indigo-600 font-bold text-2xl mb-4">Loading Draw...</div>
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto"></div>
                </div>

                <div id="app-content" class="hidden">
                    <h3 class="text-3xl font-extrabold text-indigo-800 mb-4">The Big Summer Tournament!</h3>
                    <p class="text-gray-600 mb-6">
                        Draw ID: <span id="draw-id" class="font-mono bg-yellow-100 p-1 rounded">footballcup2025</span>
                    </p>

                    <!-- User's Assigned Team -->
                    <div class="p-4 bg-white rounded-lg shadow-inner mb-6">
                        <p class="text-xl font-semibold text-indigo-700">Your Current Team:</p>
                        <p id="assigned-team" class="text-4xl font-black text-yellow-600 mt-2">
                            Awaiting Entry...
                        </p>
                    </div>

                    <!-- Action Button -->
                    <button id="enter-button" onclick="enterDraw()" 
                            class="bg-yellow-500 text-indigo-800 font-extrabold py-3 px-8 rounded-full text-lg shadow-lg hover:bg-yellow-400 transition duration-300 transform hover:scale-105 ring-4 ring-yellow-300/50">
                        Enter Draw Now!
                    </button>
                    <p id="message-area" class="mt-4 text-green-600 font-medium"></p>
                </div>
            </div>

            <!-- User ID Footer -->
            <p class="mt-8 text-sm text-gray-500">
                Your Unique ID (needed for tracking): <span id="user-id-display" class="font-mono text-xs bg-gray-200 p-1 rounded">Loading...</span>
            </p>

        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-indigo-900 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>&copy; 2025 SuperSteaks.co.uk. All Rights Reserved. </p>
        </div>
    </footer>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Setting Firebase logging for debugging
        setLogLevel('Debug');

        // Global state variables
        let db;
        let auth;
        let userId = null;
        // This is the unique ID for the current tournament draw
        const currentDrawId = 'footballcup2025';
        // List of all possible teams that can be assigned
        const teams = ['Eagles', 'Sharks', 'Dragons', 'Warriors', 'Bulls', 'Tigers', 'Lions', 'Knights', 'Rockets', 'Gladiators'];

        // Elements
        const loadingSpinner = document.getElementById('loading-spinner');
        const appContent = document.getElementById('app-content');
        const assignedTeamEl = document.getElementById('assigned-team');
        const enterButton = document.getElementById('enter-button');
        const messageArea = document.getElementById('message-area');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- CORE FIREBASE INITIALIZATION AND AUTHENTICATION ---
        window.onload = async () => {
            loadingSpinner.classList.remove('hidden');
            
            try {
                // Mandatory global variables for Canvas environment
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // Parse the configuration string
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                const firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);
                
                // Set up authentication and the data listener
                await setupAuthAndListener(initialAuthToken, appId);

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                messageArea.textContent = 'Error loading app. Check console.';
                messageArea.classList.remove('text-green-600');
                messageArea.classList.add('text-red-600');
                loadingSpinner.classList.add('hidden');
                appContent.classList.remove('hidden');
            }
        };

        /**
         * Handles user authentication and sets up the Firestore listener.
         * @param {string | null} initialAuthToken - Firebase custom token.
         * @param {string} appId - The current application ID.
         */
        async function setupAuthAndListener(initialAuthToken, appId) {
            
            // 1. Authenticate User
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed, falling back to anonymous sign-in:", error);
                // Fallback to anonymous sign-in if custom token fails
                await signInAnonymously(auth); 
            }

            // 2. Set up Auth State Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;

                    // 3. Set up Firestore Listener to check user's entry status
                    // Path: /artifacts/{appId}/users/{userId}/draw_entries/{currentDrawId}
                    const userEntryDocRef = doc(db, 
                        `artifacts/${appId}/users/${userId}/draw_entries`, 
                        currentDrawId
                    );

                    // Use onSnapshot to listen for real-time changes to the user's entry document
                    onSnapshot(userEntryDocRef, (docSnap) => {
                        loadingSpinner.classList.add('hidden');
                        appContent.classList.remove('hidden');

                        if (docSnap.exists()) {
                            // User has already entered this draw
                            const entry = docSnap.data();
                            const assignedTeam = entry.assignedTeam;
                            assignedTeamEl.textContent = assignedTeam;
                            assignedTeamEl.classList.add('text-green-600'); 
                            
                            // Disable button and update text
                            enterButton.disabled = true;
                            enterButton.textContent = 'Already Entered!';
                            enterButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-400');
                            enterButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                            
                            messageArea.textContent = `You are cheering for the ${assignedTeam}! Good luck!`;
                            messageArea.classList.remove('text-red-600', 'text-indigo-600');
                            messageArea.classList.add('text-green-600');

                        } else {
                            // User has not entered yet
                            assignedTeamEl.textContent = 'Waiting for your entry...';
                            assignedTeamEl.classList.remove('text-green-600');
                            
                            // Enable button
                            enterButton.disabled = false;
                            enterButton.textContent = 'Enter Draw Now!';
                            enterButton.classList.add('bg-yellow-500', 'hover:bg-yellow-400');
                            enterButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                            messageArea.textContent = 'Click the button to get your random team!';
                            messageArea.classList.remove('text-green-600', 'text-red-600');
                            messageArea.classList.add('text-indigo-600');
                        }
                    }, (error) => {
                        console.error("Firestore Snapshot Error:", error);
                        messageArea.textContent = 'Error connecting to the draw data.';
                        messageArea.classList.remove('text-green-600', 'text-indigo-600');
                        messageArea.classList.add('text-red-600');
                    });

                } else {
                    // Fallback UI if auth fails completely
                    console.log("User signed out or failed to sign in.");
                    userIdDisplay.textContent = 'Failed to load user ID.';
                    loadingSpinner.classList.add('hidden');
                    appContent.classList.remove('hidden');
                }
            });
        }

        // --- DRAW ENTRY LOGIC ---

        // Expose function to global scope for button click
        window.enterDraw = async () => {
            if (!userId || !db) {
                messageArea.textContent = 'App not fully loaded. Please wait.';
                messageArea.classList.add('text-red-600');
                return;
            }

            // Lock the button during processing
            enterButton.disabled = true;
            enterButton.textContent = 'Drawing Team...';
            messageArea.textContent = 'Processing your entry...';
            messageArea.classList.remove('text-red-600', 'text-green-600');
            messageArea.classList.add('text-indigo-600');

            try {
                // 1. Randomly select a team
                const randomIndex = Math.floor(Math.random() * teams.length);
                const assignedTeam = teams[randomIndex];

                // 2. Define the document reference
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userEntryDocRef = doc(db, 
                    `artifacts/${appId}/users/${userId}/draw_entries`, 
                    currentDrawId
                );

                // 3. Write the entry to Firestore
                await setDoc(userEntryDocRef, {
                    drawId: currentDrawId,
                    userId: userId,
                    assignedTeam: assignedTeam,
                    entryTimestamp: new Date().toISOString()
                }, { merge: false });

                // Success message is handled by the onSnapshot listener once data is written

            } catch (error) {
                console.error("Error entering draw:", error);
                messageArea.textContent = 'Entry failed. Please try again.';
                messageArea.classList.remove('text-indigo-600', 'text-green-600');
                messageArea.classList.add('text-red-600');
                // Re-enable button on error so the user can try again
                enterButton.disabled = false;
                enterButton.textContent = 'Enter Draw Now!';
            }
        };
    </script>
</body>
</html>
