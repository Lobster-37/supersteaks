<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperSteaks - Enter Random Team Draw</title>
    <meta name="description" content="Enter the latest SuperSteaks sports sweepstakes draw for free. Get your random team assignment and join the fun!">
    <link rel="icon" type="image/png" href="supersteaks-logo.png?v=20241118002">
    
    <!-- Cache Control -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script>
        console.log('TailwindCSS CSS loading...');
        setTimeout(() => {
            const testEl = document.createElement('div');
            testEl.className = 'bg-red-500';
            document.body.appendChild(testEl);
            const styles = getComputedStyle(testEl);
            if (styles.backgroundColor === 'rgb(239, 68, 68)' || styles.backgroundColor.includes('239')) {
                console.log('‚úÖ TailwindCSS CSS loaded successfully');
            } else {
                console.error('‚ùå TailwindCSS CSS failed to load');
            }
            document.body.removeChild(testEl);
        }, 1000);
    </script>
    
    <!-- Firebase SDK - Load first - Updated to stable version -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <!-- SuperSteaks Global System -->
    <script src="js/supersteaks-global.js?v=20241118001"></script>
    
    <!-- Firebase Configuration - Initialize immediately -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC7eQhMsCeQYcQrQq_BR1Wy7cCE4JltD5s",
            authDomain: "supersteaks-240f7.firebaseapp.com",
            projectId: "supersteaks-240f7",
            storageBucket: "supersteaks-240f7.firebasestorage.app",
            messagingSenderId: "325643072121",
            appId: "1:325643072121:web:9c3c7d3c64c431bc77daa8"
        };
        
        // Initialize Firebase immediately
        try {
            firebase.initializeApp(firebaseConfig);
            console.log('Firebase initialized successfully in head');
            
            // Set a global flag that Firebase is ready
            window.firebaseReady = true;
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            window.firebaseReady = false;
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        html { 
            overflow-y: scroll;
            height: 100%;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f4f8; 
            overflow-x: hidden;
            overflow-y: visible;
            height: auto;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        .nav-link:hover { transform: translateY(-2px); box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.2); }
        /* Authentication state management with skeleton loading */
        .logged-out #auth-buttons { display: block !important; }
        .logged-out #user-info { display: none !important; }
        .logged-out #auth-skeleton { display: none !important; }
        
        .logged-in #auth-buttons { display: none !important; }
        .logged-in #user-info { display: block !important; }
        .logged-in #auth-skeleton { display: none !important; }
        
        /* Force skeleton loading state initially - override everything */
        body:not(.auth-ready) #auth-buttons { display: none !important; }
        body:not(.auth-ready) #user-info { display: none !important; }
        body:not(.auth-ready) #auth-skeleton { display: block !important; }
        
        /* Reserve exact space to prevent layout shift */
        #user-account-section {
            min-height: 52px; /* Reserve space for 2 lines + spacing */
            width: 176px; /* Fixed width to match content */
            flex-shrink: 0;
        }
        
        /* Skeleton loading animation */
        .skeleton { 
            background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .main-content {
            min-height: calc(100vh - 200px);
        }
        /* Ensure scroll is always available */
        * {
            scrollbar-width: auto;
        }
    </style>
    
    <!-- User Account System -->

</head>
<body class="min-h-screen flex flex-col">
    <!-- Logo -->
    <a href="index.html">
      <img src="supersteaks-logo.png?v=20241118002" alt="SuperSteaks Logo" class="absolute h-20 sm:h-24 md:h-32 w-auto z-50 logo-cursor" style="filter: brightness(0.9) contrast(1.3) hue-rotate(-10deg) saturate(1.2); user-select: none;">
    </a>
    <style>
      .logo-cursor:hover {
        cursor: pointer;
      }
    </style>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const logo = document.getElementById('draggable-logo');
        const logoLink = document.getElementById('logo-link');
        let isDragging = false;
        let dragMoved = false;
        let startX, startY, initialLeft, initialTop;
        if (!logo) return;
        logo.addEventListener('mousedown', function(e) {
          isDragging = true;
          dragMoved = false;
          startX = e.clientX;
          startY = e.clientY;
          initialLeft = parseInt(logo.style.left || '0', 10);
          initialTop = parseInt(logo.style.top || '0', 10);
          e.preventDefault();
          e.stopPropagation();
          logo.style.zIndex = '9999';
        });
        document.addEventListener('mousemove', function(e) {
          if (!isDragging) return;
          dragMoved = true;
          const deltaX = e.clientX - startX;
          const deltaY = e.clientY - startY;
          logo.style.left = (initialLeft + deltaX) + 'px';
          logo.style.top = (initialTop + deltaY) + 'px';
        });
        document.addEventListener('mouseup', function(e) {
          if (isDragging) {
            isDragging = false;
            logo.style.zIndex = '50';
          }
        });
        logoLink.addEventListener('click', function(e) {
          if (dragMoved) {
            e.preventDefault();
          }
        });
      });
    </script>

    <!-- Header & Navigation -->
    <header class="bg-indigo-800 text-white shadow-xl">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
                <div class="text-center sm:text-left">
                    <a href="index.html" class="hover:opacity-80 transition-opacity">
                        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-widest text-yellow-400" aria-label="SuperSteaks Logo">SUPERSTEAKS</h1>
                    </a>
                </div>
                <div class="flex flex-col items-end space-y-3">
                    <!-- User Account Section -->
                    <div id="user-account-section">
                        <!-- Skeleton loading (prevents flash) -->
                        <div id="auth-skeleton" class="text-right">
                            <div class="skeleton h-4 mb-1 rounded ml-auto" style="width: 148px;"></div>
                            <div class="flex items-center justify-center sm:justify-end space-x-2">
                                <div class="skeleton h-6 rounded" style="width: 48px; padding: 4px 12px;"></div>
                                <div class="skeleton h-6 rounded" style="width: 64px; padding: 4px 8px;"></div>
                            </div>
                        </div>
                        
                        <!-- Login/Register buttons (when logged out) -->
                        <div id="auth-buttons" class="text-right">
                            <p class="text-yellow-400 font-semibold text-sm mb-1">Join SuperSteaks Today!</p>
                            <div class="flex items-center justify-center sm:justify-end space-x-2">
                                <button id="login-btn" class="bg-yellow-500 text-indigo-800 px-3 py-1 rounded text-xs hover:bg-yellow-400 transition font-semibold">
                                    Login
                                </button>
                                <button id="register-btn" class="bg-transparent border border-yellow-400 text-yellow-400 px-2 py-1 rounded text-xs hover:bg-yellow-400 hover:text-indigo-800 transition font-semibold">
                                    Sign Up
                                </button>
                            </div>
                        </div>
                        
                        <!-- User info (when logged in) -->
                        <div id="user-info" class="text-right">
                            <p class="text-yellow-400 font-semibold text-sm mb-1">Welcome, <span id="username-display">Lobster37</span>!</p>
                            <div class="flex items-center justify-center sm:justify-end space-x-2">
                                <div class="relative">
                                    <button id="profile-dropdown-btn" class="bg-yellow-500 text-indigo-800 px-3 py-1 rounded text-xs hover:bg-yellow-400 transition font-semibold">
                                        My Profile ‚ñº
                                    </button>
                                    <div id="profile-dropdown" class="hidden absolute right-0 mt-1 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                                        <a href="teams.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-t-lg">
                                            üìä Team Directory
                                        </a>
                                        <button id="view-profile-btn" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                            üë§ View My Profile
                                        </button>
                                        <button id="logout-btn-dropdown" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 rounded-b-lg">
                                            üö™ Logout
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <nav aria-label="Main navigation" class="mt-4">
                        <ul class="flex flex-wrap justify-center space-x-3 sm:space-x-6">
                            <li>
                                <a href="index.html" class="nav-link px-2 sm:px-3 py-2 rounded-lg transition duration-300 hover:bg-indigo-700 text-sm sm:text-base">Home</a>
                            </li>
                            <li>
                                <a href="contests.html" class="nav-link px-2 sm:px-3 py-2 rounded-lg transition duration-300 hover:bg-indigo-700 text-sm sm:text-base">Our Draws</a>
                            </li>
                            <li>
                                <a href="games.html" aria-current="page" class="nav-link px-2 sm:px-3 py-2 rounded-lg transition duration-300 bg-indigo-700 hover:bg-indigo-600 font-semibold text-yellow-400 border-2 border-yellow-400 text-sm sm:text-base">Enter Now</a>
                            </li>
                            <li>
                                <a href="rules.html" class="nav-link px-2 sm:px-3 py-2 rounded-lg transition duration-300 hover:bg-indigo-700 text-sm sm:text-base">How It Works</a>
                            </li>
                            <li>
                                <a href="contact.html" class="nav-link px-2 sm:px-3 py-2 rounded-lg transition duration-300 hover:bg-indigo-700 text-sm sm:text-base">Contact</a>
                            </li>
                        </ul>
                    </nav>
        </div>
    </header>

    <!-- Login/Register Modal -->
    <div id="auth-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 sm:p-8 max-w-md w-full mx-4 relative max-h-screen overflow-y-auto">
            <div id="login-form">
                <h2 class="text-2xl font-bold text-indigo-800 mb-6">Login to Your Account</h2>
                <form id="login-form-element">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Username or Email</label>
                        <input type="text" id="login-identifier" class="w-full px-3 py-3 border rounded-lg focus:outline-none focus:border-indigo-500 text-base" placeholder="Enter your username or email" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                        <input type="password" id="login-password" class="w-full px-3 py-3 border rounded-lg focus:outline-none focus:border-indigo-500 text-base" required>
                        <div class="text-right mt-2">
                            <button type="button" id="forgot-password-link" class="text-sm text-indigo-600 hover:underline">
                                Forgot Password?
                            </button>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
                        <button type="submit" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition w-full sm:w-auto">
                            Login
                        </button>
                        <button type="button" id="switch-to-register" class="text-indigo-600 hover:underline text-sm">
                            Need an account?
                        </button>
                    </div>
                </form>
            </div>

            <div id="register-form" class="hidden">
                <h2 class="text-2xl font-bold text-indigo-800 mb-6">Create New Account</h2>
                <form id="register-form-element">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Username</label>
                        <input type="text" id="register-username" class="w-full px-3 py-3 border rounded-lg focus:outline-none focus:border-indigo-500 text-base" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                        <input type="email" id="register-email" class="w-full px-3 py-3 border rounded-lg focus:outline-none focus:border-indigo-500 text-base" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                        <input type="password" id="register-password" class="w-full px-3 py-3 border rounded-lg focus:outline-none focus:border-indigo-500 text-base" required>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
                        <button type="submit" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition w-full sm:w-auto">
                            Register
                        </button>
                        <button type="button" id="switch-to-login" class="text-indigo-600 hover:underline text-sm">
                            Already have an account?
                        </button>
                    </div>
                </form>
            </div>

            <button id="close-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl">
                √ó
            </button>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div id="reset-password-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 relative">
            <h2 class="text-2xl font-bold text-indigo-800 mb-6">Reset Password</h2>
            <form id="reset-password-form-element">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Email Address</label>
                    <input type="email" id="reset-email" class="w-full px-3 py-3 border rounded-lg focus:outline-none focus:border-indigo-500 text-base" placeholder="Enter your email address" required>
                    <p class="text-xs text-gray-600 mt-2">We'll send you a link to reset your password</p>
                </div>
                <div class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
                    <button type="submit" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition w-full sm:w-auto">
                        Send Reset Email
                    </button>
                    <button type="button" id="cancel-reset" class="text-indigo-600 hover:underline text-sm">
                        Cancel
                    </button>
                </div>
            </form>
            <div id="reset-message" class="hidden mt-4 p-3 rounded-lg"></div>
            <button id="close-reset-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl">
                √ó
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <main aria-label="Main content" class="container mx-auto px-4 py-6 sm:py-12 flex-grow main-content" id="main-content">
        <section class="text-center bg-white p-4 sm:p-6 md:p-12 rounded-3xl shadow-2xl border-b-4 border-yellow-400">
            <h2 class="text-2xl sm:text-4xl md:text-5xl font-black text-indigo-900 mb-4 leading-tight">
                Current <span class="text-yellow-500">Free Draw</span>
            </h2>
            <p class="text-sm sm:text-lg text-gray-700 max-w-4xl mx-auto mb-6 sm:mb-8">
                Ready for the fun? Click "Enter Draw" below to get your random team assignment!
            </p>

            <!-- Draw Card -->
            <div id="draw-card" class="max-w-xl mx-auto bg-indigo-50 p-8 rounded-2xl shadow-xl transition-all duration-500">
                <div id="app-content">
                    <h3 class="text-3xl font-extrabold text-indigo-800 mb-4">Random Team Assignment Draw!</h3>
                    <p class="text-gray-600 mb-6">
                        Draw ID: <span id="draw-id" class="font-mono bg-yellow-100 p-1 rounded">champleague25/26</span>
                    </p>

                    <!-- User's Assigned Team -->
                    <div id="team-container" class="p-4 sm:p-8 bg-white rounded-lg shadow-inner mb-6 h-24 sm:h-32 border-4 border-yellow-400">
                        <p class="text-lg sm:text-xl font-semibold text-indigo-700 mb-2">Your Current Team:</p>
                        <div id="team-display" class="flex flex-col items-center mt-2 sm:mt-4">
                            <img id="team-badge" src="" alt="Team Badge" class="w-16 h-16 sm:w-20 sm:h-20 mb-3 team-badge hidden">
                            <p id="assigned-team" class="text-xl sm:text-4xl font-black text-yellow-600 text-center px-2 js-ui-element">
                                Awaiting Entry...
                            </p>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row gap-4 sm:gap-0 items-center justify-center js-ui-element">
                        <button id="enter-button" onclick="enterDraw()" 
                                class="bg-yellow-500 hover:bg-yellow-400 text-indigo-800 font-extrabold py-3 px-6 sm:px-8 rounded-full text-base sm:text-lg shadow-lg transition duration-300 transform hover:scale-105 ring-4 ring-yellow-300/50 w-full sm:w-auto">
                            Enter Draw Now!
                        </button>
                        
                        <!-- Test Login Button -->
                        <button onclick="console.log('Testing...'); console.log('SuperSteaksAuth:', window.SuperSteaksAuth); enterDraw();" 
                                class="ml-0 sm:ml-2 bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg text-sm hover:bg-blue-600 transition duration-300 w-full sm:w-auto">
                            Test Login Version
                        </button>
                        
                        <!-- Reset Button (for testing) -->
                        <button onclick="resetDraw()" 
                                class="ml-0 sm:ml-2 bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg text-sm hover:bg-gray-600 transition duration-300 w-full sm:w-auto">
                            Reset Draw
                        </button>
                    </div>
                    
                    <p id="message-area" aria-live="polite" class="text-center text-base sm:text-lg mt-4 text-indigo-600">Click the button to get your random team!</p>
                </div>
            </div>

            <script>
                // Simplified approach - just show static logged-out state
                // Remove all dynamic state changes to eliminate flickering
            </script>

            <!-- User ID Footer -->
            <p class="mt-8 text-sm text-gray-500">
                Your Unique ID (needed for tracking): <span id="user-id-display" class="font-mono text-xs bg-gray-200 p-1 rounded">demo_xxxxxxxxx</span>
            </p>

        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-indigo-900 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>&copy; 2025 SuperSteaks. All Rights Reserved. </p>
        </div>
    </footer>

    <!-- Teams data and game logic starts here -->
    <script>
      // Updated teams with specific stripe patterns and border colors
      const teams = [
        { name: "Ajax", pattern: "ajax-stripe", borderColor: "#D2122E" },
        { name: "Arsenal", color: "#EF0107", borderColor: "#FFFFFF" },
        { name: "Atalanta", pattern: "stripes-vertical-blue-black", borderColor: "#1E63B0" },
        { name: "Athletic Club", pattern: "stripes-vertical-red-white", borderColor: "#EE2523" },
        { name: "Atl√©tico Madrid", pattern: "stripes-vertical-red-white", borderColor: "#CE3524" },
        { name: "Barcelona", pattern: "stripes-vertical-blue-garnet", borderColor: "#A50044" },
        { name: "Bayer Leverkusen", color: "#000000", borderColor: "#E32221" },
        { name: "Bayern M√ºnchen", color: "#DC052D", borderColor: "#0066B2" },
        { name: "Benfica", color: "#E20E0E", borderColor: "#FFFFFF" },
        { name: "Bod√∏/Glimt", color: "#FFD700", borderColor: "#000000" },
        { name: "Borussia Dortmund", color: "#FDE100", borderColor: "#000000" },
        { name: "Chelsea", color: "#034694", borderColor: "#FFFFFF" },
        { name: "Club Brugge", pattern: "stripes-vertical-blue-black", borderColor: "#0032A0" },
        { name: "Copenhagen", color: "#FFFFFF", borderColor: "#1F4E79" },
        { name: "Eintracht Frankfurt", color: "#000000", borderColor: "#E1001C" },
        { name: "Galatasaray", pattern: "diagonal-half-yellow-red", borderColor: "#FFD700" },
        { name: "Inter Milan", pattern: "stripes-vertical-blue-black", borderColor: "#0068A8" },
        { name: "Juventus", pattern: "stripes-vertical-black-white", borderColor: "#000000" },
        { name: "Kairat Almaty", pattern: "stripes-vertical-yellow-black", borderColor: "#FFD700" },
        { name: "Liverpool", color: "#C8102E", borderColor: "#FFD700" },
        { name: "Manchester City", color: "#6CABDD", borderColor: "#FFFFFF" },
        { name: "Marseille", color: "#FFFFFF", borderColor: "#009EDB" },
        { name: "Monaco", pattern: "diagonal-half-red-white", borderColor: "#C8102E" },
        { name: "Napoli", color: "#87CEEB", borderColor: "#FFFFFF" },
        { name: "Newcastle United", pattern: "stripes-vertical-black-white", borderColor: "#000000" },
        { name: "Olympiacos", pattern: "stripes-vertical-red-white", borderColor: "#DC143C" },
        { name: "Pafos FC", color: "#0066CC", borderColor: "#FFFFFF" },
        { name: "Paris Saint-Germain", color: "#004170", borderColor: "#C8102E" },
        { name: "PSV Eindhoven", pattern: "stripes-vertical-red-white", borderColor: "#ED1C24" },
        { name: "Qarabaƒü", color: "#000000", borderColor: "#FFFFFF" },
        { name: "Real Madrid", color: "#FFFFFF", borderColor: "#FFD700" },
        { name: "Slavia Praha", pattern: "diagonal-half-red-white", borderColor: "#C8102E" },
        { name: "Sporting CP", pattern: "stripes-horizontal-green-white", borderColor: "#006837" },
        { name: "Tottenham Hotspur", color: "#FFFFFF", borderColor: "#132257" },
        { name: "Union Saint-Gilloise", color: "#FFD100", borderColor: "#0033A0" },
        { name: "Villarreal", color: "#FFE667", borderColor: "#003366" }
      ];
      const currentDrawId = 'champleague25/26';

      // DOM elements
      const loadingSpinner = document.getElementById('loading-spinner');
      const appContent = document.getElementById('app-content');
      const assignedTeamEl = document.getElementById('assigned-team');
      
      // Immediate scroll fix - run as soon as DOM elements are available
      (function() {
        document.body.style.overflow = 'visible';
        document.body.style.overflowY = 'auto';
        document.documentElement.style.overflow = 'visible';
        document.documentElement.style.overflowY = 'auto';
      })();
      const teamBadgeEl = document.getElementById('team-badge');
      const teamContainerEl = document.getElementById('team-container');
      const teamShirtEl = document.getElementById('team-shirt');
      const shirtBodyEl = document.getElementById('shirt-body');
      const shirtCollarEl = document.getElementById('shirt-collar');
      const shirtSleeveLeftEl = document.getElementById('shirt-sleeve-left');
      const shirtSleeveRightEl = document.getElementById('shirt-sleeve-right');
      const shirtTextEl = document.getElementById('shirt-text');
      const shirtNumberEl = document.getElementById('shirt-number');
      const enterButton = document.getElementById('enter-button');
      const messageArea = document.getElementById('message-area');
      const userIdDisplay = document.getElementById('user-id-display');

      let userId = null;
      let db = null;

      // Helper function to darken colors for gradient effect
      function darkenColor(color, percent) {
        const num = parseInt(color.replace("#", ""), 16);
        const amt = Math.round(2.55 * percent * 100);
        const R = (num >> 16) - amt;
        const G = (num >> 8 & 0x00FF) - amt;
        const B = (num & 0x0000FF) - amt;
        return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
          (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
          (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
      }

      window.onload = function() {
        // Force enable scrolling immediately
        document.body.style.overflow = 'visible';
        document.documentElement.style.overflow = 'visible';
        document.body.style.overflowY = 'auto';
        document.documentElement.style.overflowY = 'auto';
        
        console.log('Games page loaded');
        
        // Check for existing team assignment using global system
        setTimeout(async () => {
          if (window.superSteaksGlobal && window.superSteaksGlobal.isAuthenticated()) {
            const contestName = 'Champions League Draw';
            const existingAssignment = await window.superSteaksGlobal.getUserAssignment(contestName);
            
            if (existingAssignment) {
              console.log('User has existing team assignment:', existingAssignment);
              const teamName = existingAssignment.team;
              
              // Find the team data to get styling information
              const teamData = teams.find(t => t.name === teamName);
              
              if (teamData) {
                // Display the assigned team with proper styling
                displayUserTeam(teamData);
                
                enterButton.disabled = true;
                enterButton.textContent = 'Already Entered!';
                enterButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-400');
                enterButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                messageArea.innerHTML = `You are cheering for ${teamName}! Good luck!<br><a href="teams.html" class="inline-block mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition duration-200">üèÜ View All Teams</a>`;
                messageArea.classList.remove('text-indigo-600');
                messageArea.classList.add('text-green-600');
              }
            }
          }
        }, 1000);
      };

      // Fallback function that works without login (for testing)
      function enterDrawSimple() {
        console.log('enterDrawSimple called - no login required');
        
        // Check if all required elements exist
        if (!enterButton) {
          console.error('enterButton not found');
          return;
        }
        if (!messageArea) {
          console.error('messageArea not found');
          return;
        }
        if (!assignedTeamEl) {
          console.error('assignedTeamEl not found');
          return;
        }
        if (!teamContainerEl) {
          console.error('teamContainerEl not found');
          return;
        }
        
        console.log('All elements found, starting draw process');
        
        enterButton.disabled = true;
        enterButton.textContent = 'Drawing Team...';
        messageArea.textContent = 'Processing your entry...';
        messageArea.classList.remove('text-red-600', 'text-green-600');
        messageArea.classList.add('text-indigo-600');

        setTimeout(() => {
          const selectedTeam = teams[Math.floor(Math.random() * teams.length)];
          console.log('Selected team:', selectedTeam);

          // Update UI
          assignedTeamEl.textContent = selectedTeam.name;
          assignedTeamEl.classList.add('text-green-600');
          
          // Apply team styling
          teamContainerEl.className = teamContainerEl.className.replace(/stripes-\w+|diagonal-half|ajax-stripe/g, '');
          teamContainerEl.style.borderColor = selectedTeam.borderColor || '#10B981';
          
          if (selectedTeam.pattern) {
            teamContainerEl.classList.add(selectedTeam.pattern);
            teamContainerEl.style.backgroundColor = 'transparent';
          } else {
            teamContainerEl.style.backgroundColor = selectedTeam.color || '#4f46e5';
          }
          
          enterButton.disabled = true;
          enterButton.textContent = 'Team Assigned!';
          enterButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-400');
          enterButton.classList.add('bg-gray-400', 'cursor-not-allowed');
          messageArea.innerHTML = `Congratulations! You've been assigned: ${selectedTeam.name}<br><a href="teams.html" class="inline-block mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition duration-200">üèÜ View All Teams</a>`;
          messageArea.classList.remove('text-red-600', 'text-indigo-600');
          messageArea.classList.add('text-green-600');
          
          console.log('Team assignment completed successfully');
        }, 1000);
      }

      // Reset function for testing
      function resetDraw() {
        localStorage.clear();
        assignedTeamEl.textContent = 'Awaiting Entry...';
        assignedTeamEl.classList.remove('text-green-600');
        // Reset container to default white background
        teamContainerEl.className = 'p-8 bg-white rounded-lg shadow-inner mb-6 min-h-32 border-4 border-yellow-400';
        enterButton.disabled = false;
        enterButton.textContent = 'Enter Draw Now!';
        enterButton.classList.add('bg-yellow-500', 'hover:bg-yellow-400');
        enterButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
        messageArea.textContent = 'Click the button to get your random team!';
        messageArea.classList.remove('text-green-600', 'text-red-600');
        messageArea.classList.add('text-indigo-600');
      }

      // ===== USER ACCOUNT SYSTEM =====
      
      // Account Management Functions
      function createAccount(username, email, password) {
        console.log('Attempting registration for:', username);
        console.log('SuperSteaksAuth available:', !!window.SuperSteaksAuth);
        
        if (!window.SuperSteaksAuth) {
          throw new Error('Authentication system not loaded');
        }
        
        return window.SuperSteaksAuth.register(username, email, password);
      }
      
      function loginUser(username, password) {
        console.log('Attempting login for:', username);
        console.log('SuperSteaksAuth available:', !!window.SuperSteaksAuth);
        
        if (!window.SuperSteaksAuth) {
          throw new Error('Authentication system not loaded');
        }
        
        return window.SuperSteaksAuth.login(username, password);
      }
      
      function getCurrentUser() {
        return window.SuperSteaksAuth.getCurrentUser();
      }
      
      async function logoutUser() {
        if (window.superSteaksGlobal) {
          const result = await window.superSteaksGlobal.signOut();
          if (result.success) {
            console.log('User logged out successfully');
            // UI will update automatically via auth state listener
          } else {
            console.error('Logout failed:', result.error);
          }
        }
      }
      
      function assignTeamToUser(username, team) {
        const users = JSON.parse(localStorage.getItem('champLeagueUsers') || '{}');
        if (users[username]) {
          users[username].assignedTeam = team;
          users[username].drawHistory.push({
            team: team,
            drawId: currentDrawId,
            timestamp: new Date().toISOString()
          });
          localStorage.setItem('champLeagueUsers', JSON.stringify(users));
        }
      }
      
      // UI Management Functions - use the new authentication system
      function updateUIForLoggedInState(user) {
        console.log('Updating UI for logged in user:', user);
        
        // This function is now replaced by showLoggedInState() from the new auth system
        // Redirect to new function for consistency
        if (user) {
          showLoggedInState(user);
        }
      }
      
      function updateUIForLoggedOutState() {
        document.getElementById('auth-buttons').classList.remove('hidden');
        document.getElementById('user-info').classList.add('hidden');
        
        // Reset the draw interface but allow interaction
        assignedTeamEl.textContent = 'Awaiting Entry...';
        assignedTeamEl.classList.remove('text-green-600');
        teamContainerEl.className = 'p-8 bg-white rounded-lg shadow-inner mb-6 min-h-32 border-4 border-yellow-400';
        enterButton.disabled = false;
        enterButton.textContent = 'Enter Draw Now!';
        enterButton.classList.add('bg-yellow-500', 'hover:bg-yellow-400');
        enterButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
        messageArea.textContent = 'Click the button to get your random team!';
        messageArea.classList.add('text-indigo-600');
        messageArea.classList.remove('text-red-600', 'text-green-600');
      }
      
      function displayUserTeam(team) {
        assignedTeamEl.textContent = team.name;
        assignedTeamEl.classList.add('text-green-600');
        
        // Apply team pattern/color to container
        teamContainerEl.className = teamContainerEl.className.replace(/stripes-\w+|diagonal-half|ajax-stripe/g, '');
        teamContainerEl.style.borderColor = team.borderColor;
        
        if (team.pattern) {
          teamContainerEl.classList.add(team.pattern);
          teamContainerEl.style.backgroundColor = 'transparent';
        } else {
          teamContainerEl.style.backgroundColor = team.color;
        }
        
        messageArea.textContent = `You are supporting ${team.name}! Good luck!`;
        messageArea.classList.remove('text-red-600', 'text-indigo-600');
        messageArea.classList.add('text-green-600');
      }
      
      // Modal Management
      function showAuthModal(showRegister = false) {
        document.getElementById('auth-modal').classList.remove('hidden');
        if (showRegister) {
          document.getElementById('login-form').classList.add('hidden');
          document.getElementById('register-form').classList.remove('hidden');
        } else {
          document.getElementById('login-form').classList.remove('hidden');
          document.getElementById('register-form').classList.add('hidden');
        }
      }
      
      function hideAuthModal() {
        document.getElementById('auth-modal').classList.add('hidden');
        // Clear form inputs
        document.getElementById('login-form-element').reset();
        document.getElementById('register-form-element').reset();
      }
      
      // Password Reset Modal Functions
      function showResetPasswordModal() {
        document.getElementById('auth-modal').classList.add('hidden');
        document.getElementById('reset-password-modal').classList.remove('hidden');
      }
      
      function hideResetPasswordModal() {
        document.getElementById('reset-password-modal').classList.add('hidden');
        document.getElementById('reset-password-form-element').reset();
      }
      
      async function resetPassword(email) {
        console.log('Reset password function called with email:', email);
        const messageDiv = document.getElementById('reset-message');
        
        try {
          console.log('Attempting to send Firebase reset email...');
          await firebase.auth().sendPasswordResetEmail(email);
          console.log('Firebase reset email sent successfully');
          
          // Close modal instantly and clear form
          hideResetPasswordModal();
          document.getElementById('reset-email').value = '';
          
          // Show success message on main screen
          const successMsg = document.createElement('div');
          successMsg.className = 'fixed top-4 right-4 z-50 bg-green-100 text-green-700 px-6 py-3 rounded-lg shadow-lg font-medium';
          successMsg.textContent = '‚úÖ Password reset email sent! Check your inbox.';
          document.body.appendChild(successMsg);
          
          // Remove message after 3 seconds
          setTimeout(() => {
            if (successMsg.parentNode) {
              successMsg.parentNode.removeChild(successMsg);
            }
          }, 3000);
        } catch (error) {
          console.error('Firebase reset email error:', error);
          
          // Show error message on main screen
          const errorMsg = document.createElement('div');
          errorMsg.className = 'fixed top-4 right-4 z-50 bg-red-100 text-red-700 px-6 py-3 rounded-lg shadow-lg font-medium';
          errorMsg.textContent = '‚ùå Error: ' + (error?.message || 'Password reset failed. Please try again.');
          document.body.appendChild(errorMsg);
          
          // Remove error message after 5 seconds
          setTimeout(() => {
            if (errorMsg.parentNode) {
              errorMsg.parentNode.removeChild(errorMsg);
            }
          }, 5000);
        }
      }
      
      // Updated Enter Draw Function using Firebase
      async function enterDraw() {
        console.log('enterDraw called');
        
        // Check if global system is ready and user is authenticated
        if (!window.superSteaksGlobal || !window.superSteaksGlobal.isAuthenticated()) {
          console.log('User not authenticated, showing modal');
          showAuthModal(false);
          return;
        }
        
        const contestName = 'Champions League Draw';
        
        // Check if user already has assignment
        const existingAssignment = await window.superSteaksGlobal.getUserAssignment(contestName);
        if (existingAssignment) {
          messageArea.textContent = `You already have ${existingAssignment.team} assigned for this contest!`;
          messageArea.classList.remove('text-green-600', 'text-indigo-600');
          messageArea.classList.add('text-red-600');
          return;
        }
        
        // Start the draw animation
        enterButton.disabled = true;
        enterButton.textContent = 'Drawing...';
        messageArea.textContent = 'Connecting to global draw system...';
        messageArea.classList.remove('text-red-600', 'text-green-600');
        messageArea.classList.add('text-indigo-600');
        
        setTimeout(async () => {
          try {
            // Enter the draw using global system
            const result = await window.superSteaksGlobal.enterDraw(contestName);
            
            if (result.success) {
              const selectedTeam = result.team;
              
              // Update UI
              displayUserTeam(selectedTeam);
              
              enterButton.textContent = 'Team Assigned!';
              enterButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-400');
              enterButton.classList.add('bg-gray-400', 'cursor-not-allowed');
              
              messageArea.innerHTML = `Congratulations! You've been assigned: ${selectedTeam.name}<br><small class="text-sm">${result.remainingTeams} teams remaining globally</small><br><a href="teams.html" class="inline-block mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition duration-200">üèÜ View All Teams</a>`;
              messageArea.classList.remove('text-indigo-600');
              messageArea.classList.add('text-green-600');
              
            } else {
              // Show error message
              messageArea.textContent = result.error;
              messageArea.classList.remove('text-green-600', 'text-indigo-600');
              messageArea.classList.add('text-red-600');
              
              // Reset button if contest is full
              if (result.error.includes('Contest is full')) {
                enterButton.textContent = 'Contest Full';
                enterButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-400');
                enterButton.classList.add('bg-gray-400', 'cursor-not-allowed');
              } else {
                // Re-enable button for other errors
                enterButton.disabled = false;
                enterButton.textContent = 'Enter Draw Now!';
              }
            }
            
          } catch (error) {
            console.error('Error in draw:', error);
            messageArea.textContent = 'Connection error. Please try again.';
            messageArea.classList.remove('text-green-600', 'text-indigo-600');
            messageArea.classList.add('text-red-600');
            
            // Re-enable button
            enterButton.disabled = false;
            enterButton.textContent = 'Enter Draw Now!';
          }
        }, 2000);
      }
      
      // Event Listeners
      document.getElementById('login-btn').addEventListener('click', () => showAuthModal(false));
      document.getElementById('register-btn').addEventListener('click', () => showAuthModal(true));
      document.getElementById('close-modal').addEventListener('click', hideAuthModal);
      
        // Fixed logout functionality
        function logoutUserHardcoded() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userTeamAssignments');
            window.location.href = 'index.html';
        }
        
        // Fixed logout functionality
        function logoutUserHardcoded() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userTeamAssignments');
            window.location.href = 'index.html';
        }
        
        // Profile dropdown functionality
        document.addEventListener('DOMContentLoaded', function() {
        console.log('Games dropdown script loaded');
        document.addEventListener('click', function(e) {
          if (!e || !e.target) return;
          
          const dropdownBtn = document.getElementById('profile-dropdown-btn');
          const dropdown = document.getElementById('profile-dropdown');
          const logoutBtnDropdown = document.getElementById('logout-btn-dropdown');
          
          if (dropdownBtn && e.target === dropdownBtn) {
            console.log('Games dropdown button clicked');
            if (dropdown) {
              dropdown.classList.toggle('hidden');
            }
          } else if (dropdown && !dropdown.contains(e.target)) {
            dropdown.classList.add('hidden');
          }
          
          if (logoutBtnDropdown && e.target === logoutBtnDropdown) {
            logoutUserHardcoded();
            if (dropdown) dropdown.classList.add('hidden');
          }
        });
      });
      
      // Password Reset Event Listeners
      document.getElementById('forgot-password-link').addEventListener('click', showResetPasswordModal);
      document.getElementById('close-reset-modal').addEventListener('click', hideResetPasswordModal);
      document.getElementById('cancel-reset').addEventListener('click', hideResetPasswordModal);
      
      document.getElementById('switch-to-register').addEventListener('click', () => {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('register-form').classList.remove('hidden');
      });
      
      document.getElementById('switch-to-login').addEventListener('click', () => {
        document.getElementById('register-form').classList.add('hidden');
        document.getElementById('login-form').classList.remove('hidden');
      });
      
      // Form Submissions using Firebase Auth
      document.getElementById('login-form-element').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-identifier').value; // Using email for login
        const password = document.getElementById('login-password').value;
        
        if (!window.superSteaksGlobal) {
          alert('System not ready. Please try again in a moment.');
          return;
        }
        
        try {
          console.log('Login attempt - Email:', email);
          const result = await window.superSteaksGlobal.signIn(email, password);
          
          if (result.success) {
            console.log('Login successful');
            hideAuthModal();
            messageArea.textContent = `Welcome back, ${result.user.displayName || email}!`;
            messageArea.classList.remove('text-red-600', 'text-indigo-600');
            messageArea.classList.add('text-green-600');
          } else {
            alert(result.error);
          }
        } catch (error) {
          console.error('Login error:', error);
          alert('Login failed. Please try again.');
        }
      });
      
      document.getElementById('register-form-element').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('register-username').value.trim();
        const email = document.getElementById('register-email').value.trim();
        const password = document.getElementById('register-password').value;
        
        // Comprehensive validation
        if (!username) {
          alert('Username is required. Please enter a username.');
          document.getElementById('register-username').focus();
          return;
        }
        
        if (username.length < 3) {
          alert('Username must be at least 3 characters long.');
          document.getElementById('register-username').focus();
          return;
        }
        
        if (username.length > 20) {
          alert('Username must be 20 characters or less.');
          document.getElementById('register-username').focus();
          return;
        }
        
        if (!/^[a-zA-Z0-9._-]+$/.test(username)) {
          alert('Username can only contain letters, numbers, dots, underscores, and hyphens.');
          document.getElementById('register-username').focus();
          return;
        }
        
        if (!email) {
          alert('Email is required.');
          document.getElementById('register-email').focus();
          return;
        }
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          alert('Please enter a valid email address.');
          document.getElementById('register-email').focus();
          return;
        }
        
        if (!password) {
          alert('Password is required.');
          document.getElementById('register-password').focus();
          return;
        }
        
        if (password.length < 6) {
          alert('Password must be at least 6 characters long.');
          document.getElementById('register-password').focus();
          return;
        }
        
        if (!window.superSteaksGlobal) {
          alert('System not ready. Please try again in a moment.');
          return;
        }
        
        try {
          const result = await window.superSteaksGlobal.signUp(email, password, username);
          
          if (result.success) {
            console.log('Registration successful');
            hideAuthModal();
            messageArea.textContent = `Account created! Welcome, ${username}!`;
            messageArea.classList.remove('text-red-600', 'text-indigo-600');
            messageArea.classList.add('text-green-600');
          } else {
            alert(result.error);
          }
        } catch (error) {
          console.error('Registration error:', error);
          alert('Registration failed. Please try again.');
        }
      });
      
      // Password Reset Form Submission
      document.getElementById('reset-password-form-element').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('reset-email').value;
        
        // The resetPassword function now handles all success/error messaging and modal closing
        await resetPassword(email);
      });
      
      // Close modal when clicking outside
      document.getElementById('auth-modal').addEventListener('click', function(e) {
        if (e.target.id === 'auth-modal') {
          hideAuthModal();
        }
      });
      
      // Close password reset modal when clicking outside
      document.getElementById('reset-password-modal').addEventListener('click', function(e) {
        if (e.target.id === 'reset-password-modal') {
          hideResetPasswordModal();
        }
      });
      
      // Global error handler for catching Firebase and destructuring errors
      window.addEventListener('error', function(e) {
          if (e.message && (e.message.includes('Cannot destructure property') || e.filename && e.filename.includes('auth.ts'))) {
              console.warn('Caught Firebase/destructuring error:', e.message, 'at', e.filename, ':', e.lineno);
              // Don't let Firebase auth errors crash the page
              e.preventDefault();
              return true;
          }
      });
      
      // Additional unhandled promise rejection handler for Firebase
      window.addEventListener('unhandledrejection', function(event) {
          if (event.reason && event.reason.toString().includes('auth')) {
              console.warn('Caught unhandled Firebase auth promise rejection:', event.reason);
              event.preventDefault();
          }
      });

      document.addEventListener('DOMContentLoaded', function() {
          initializeAuthentication();
      });
      
      function initializeAuthentication() {
          console.log('Starting Firebase authentication...');
          
          // Try multiple approaches to get the authentication system
          if (window.superSteaksGlobal) {
              // Use existing global instance
              window.supersteaks = window.superSteaksGlobal;
              console.log('Using existing superSteaksGlobal instance');
              checkCurrentAuthState();
          } else if (typeof SuperSteaks !== 'undefined') {
              // Create new instance from class
              window.supersteaks = new SuperSteaks();
              console.log('Created new SuperSteaks instance');
              checkCurrentAuthState();
          } else {
              // Wait for system to initialize
              console.log('Waiting for SuperSteaks system to initialize...');
              const checkSystem = setInterval(() => {
                  if (window.superSteaksGlobal) {
                      window.supersteaks = window.superSteaksGlobal;
                      console.log('SuperSteaks global system now available');
                      checkCurrentAuthState();
                      clearInterval(checkSystem);
                  } else if (typeof SuperSteaks !== 'undefined') {
                      window.supersteaks = new SuperSteaks();
                      console.log('SuperSteaks class now available');
                      checkCurrentAuthState();
                      clearInterval(checkSystem);
                  }
              }, 100);
              
              // Fallback after 5 seconds
              setTimeout(() => {
                  if (!window.supersteaks) {
                      console.log('SuperSteaks not available after timeout, showing login buttons');
                      showLoggedOutState();
                      clearInterval(checkSystem);
                  }
              }, 5000);
          }
          
          setupEventListeners();
      }
      
      function checkCurrentAuthState() {
          // Don't check current user immediately - wait for onAuthStateChanged
          // This prevents premature showing of logged-out state
          
          // Set up auth state listener with error protection
          try {
              firebase.auth().onAuthStateChanged((user) => {
                  try {
                      if (user) {
                          console.log('Auth state determined - User logged in:', user.email);
                          showLoggedInState(user);
                      } else {
                          console.log('Auth state determined - User logged out');
                          showLoggedOutState();
                      }
                  } catch (error) {
                      console.error('Error in auth state change handler:', error);
                      // Fallback to logged-out state on error
                      showLoggedOutState();
                  }
              }, (error) => {
                  console.error('Firebase auth state listener error:', error);
                  // Fallback to logged-out state on auth error
                  showLoggedOutState();
              });
          } catch (error) {
              console.error('Error setting up auth state listener:', error);
              // Fallback to logged-out state if listener setup fails
              showLoggedOutState();
          }
      }
      
      function showLoggedInState(user) {
          console.log('Setting logged-in state for user:', user.email);
          
          // Add small delay to ensure smooth transition
          setTimeout(() => {
              // Mark auth as ready and update classes
              document.body.className = document.body.className.replace(/logged-\w+/g, '').replace(/auth-ready/g, '') + ' auth-ready logged-in';
              
              const usernameDisplay = document.getElementById('username-display');
              if (usernameDisplay && user) {
                  // Extract username from email or use display name
                  let username = user.displayName;
                  if (!username && user.email) {
                      username = user.email.split('@')[0];
                  }
                  if (username) {
                      usernameDisplay.textContent = username;
                      console.log('Username display updated to:', username);
                  }
              }
          }, 100);
      }
      
      function showLoggedOutState() {
          console.log('Setting logged-out state');
          
          // Add small delay to ensure smooth transition
          setTimeout(() => {
              // Mark auth as ready and update classes
              document.body.className = document.body.className.replace(/logged-\w+/g, '').replace(/auth-ready/g, '') + ' auth-ready logged-out';
          }, 100);
      }
      
      function setupEventListeners() {
          // Login button
          const loginBtn = document.getElementById('login-btn');
          if (loginBtn) {
              loginBtn.addEventListener('click', () => {
                  document.getElementById('auth-modal').classList.remove('hidden');
                  document.getElementById('login-form').classList.remove('hidden');
                  document.getElementById('register-form').classList.add('hidden');
              });
          }
          
          // Register button
          const registerBtn = document.getElementById('register-btn');
          if (registerBtn) {
              registerBtn.addEventListener('click', () => {
                  document.getElementById('auth-modal').classList.remove('hidden');
                  document.getElementById('register-form').classList.remove('hidden');
                  document.getElementById('login-form').classList.add('hidden');
              });
          }
          
          // Profile dropdown
          const profileBtn = document.getElementById('profile-dropdown-btn');
          const profileDropdown = document.getElementById('profile-dropdown');
          const logoutBtn = document.getElementById('logout-btn-dropdown');
          const viewProfileBtn = document.getElementById('view-profile-btn');

          if (profileBtn && profileDropdown) {
              profileBtn.addEventListener('click', function(e) {
                  if (e && e.stopPropagation) {
                      e.stopPropagation();
                  }
                  profileDropdown.classList.toggle('hidden');
              });

              document.addEventListener('click', function(e) {
                  if (profileDropdown && !profileDropdown.contains(e?.target)) {
                      profileDropdown.classList.add('hidden');
                  }
              });
          }

          if (logoutBtn) {
              logoutBtn.addEventListener('click', function() {
                  if (window.supersteaks) {
                      window.supersteaks.logout()
                          .then(() => {
                              console.log('Logout successful');
                              showLoggedOutState();
                          })
                          .catch(error => {
                              console.error('Logout failed:', error);
                          });
                  } else {
                      showLoggedOutState();
                  }
                  profileDropdown.classList.add('hidden');
              });
          }
          
          if (viewProfileBtn) {
              viewProfileBtn.addEventListener('click', function() {
                  // Open profile modal or redirect
                  alert('Profile viewing feature - would show user profile and stats');
                  profileDropdown.classList.add('hidden');
              });
          }
      }
    </script>
</body>
</html>