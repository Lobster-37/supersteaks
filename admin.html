<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Admin - SuperSteaks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-functions-compat.js"></script>
</head>
<body class="bg-gray-100">
    <div class="max-w-4xl mx-auto p-8">
        <h1 class="text-3xl font-bold mb-8">Tournament Admin Panel</h1>

        <div id="loginForm" class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-bold mb-4">Admin Login</h2>
            <div class="space-y-4">
                <div>
                    <label class="block mb-2">Email:</label>
                    <input type="email" id="email" class="w-full border p-2 rounded" placeholder="admin@example.com">
                </div>
                <div>
                    <label class="block mb-2">Password:</label>
                    <input type="password" id="password" class="w-full border p-2 rounded">
                </div>
                <button onclick="login()" class="w-full bg-blue-600 text-white p-2 rounded font-bold">Login</button>
            </div>
            <div id="loginError" class="mt-4 text-red-600 hidden"></div>
        </div>

        <div id="adminPanel" class="hidden">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-4">Refresh Tournaments</h2>
                <p class="mb-4 text-gray-600">Click to replace all tournaments with the 5-league setup:</p>
                <button onclick="refreshTournaments()" class="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700">
                    Refresh Tournaments
                </button>
                <div id="status" class="mt-4"></div>
            </div>

            <div class="mt-6 bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-bold mb-2">New User Signups</h2>
                <p class="mb-4 text-gray-600">Live feed of the most recent account registrations.</p>
                <div id="signupSummary" class="text-sm text-gray-600 mb-3">Loading signup activity...</div>
                <div id="signupList" class="space-y-2"></div>
            </div>

            <div class="mt-6">
                <button onclick="logout()" class="bg-red-600 text-white px-6 py-2 rounded font-bold">Logout</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAJF4VZM-_dJSL9p0Z2G5-Y3_JYa5TI8mw",
            authDomain: "supersteaks-240f7.firebaseapp.com",
            projectId: "supersteaks-240f7",
            storageBucket: "supersteaks-240f7.appspot.com",
            messagingSenderId: "397886230849",
            appId: "1:397886230849:web:e17e36fa33e28c26e5e0f5",
            databaseURL: "https://supersteaks-240f7.firebaseio.com"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let signupUnsubscribe = null;

        const tournamentData = [
            {
                name: "UEFA Champions League 2025-26",
                description: "Europe's elite club competition - the best of the best",
                teamCount: 32,
                teams: [
                    "Real Madrid", "Barcelona", "Atletico Madrid", "Sevilla",
                    "Manchester City", "Manchester United", "Liverpool", "Arsenal", "Chelsea", "Tottenham",
                    "Inter Milan", "AC Milan", "Juventus", "Roma", "Napoli",
                    "Bayern Munich", "Borussia Dortmund", "RB Leipzig", "Leverkusen",
                    "Paris Saint-Germain", "AS Monaco", "Marseille",
                    "Benfica", "Porto", "Sporting Lisbon",
                    "Ajax", "PSV Eindhoven",
                    "Galatasaray", "Fiorentina", "Shakhtar Donetsk", "Sheriff Tiraspol"
                ]
            },
            {
                name: "Premier League 2025-26",
                description: "The most-watched football league in the world - 20 English giants",
                teamCount: 20,
                teams: [
                    "Manchester City", "Manchester United", "Liverpool", "Arsenal", "Chelsea",
                    "Tottenham", "Newcastle United", "Brighton", "Aston Villa", "Wolves",
                    "Everton", "Leicester City", "Brentford", "West Ham", "Southampton",
                    "Crystal Palace", "Fulham", "Ipswich Town", "Nottingham Forest", "Luton Town"
                ]
            },
            {
                name: "Championship 2025-26",
                description: "England's second division - 24 teams fighting for promotion",
                teamCount: 24,
                teams: [
                    "Leeds United", "Southampton", "Leicester City", "Ipswich Town", "Norwich City",
                    "Coventry City", "West Bromwich Albion", "Sunderland", "Burnley", "Watford",
                    "Middlesbrough", "Bristol City", "Derby County", "Plymouth Argyle", "Preston North End",
                    "Millwall", "Hull City", "Luton Town", "Blackburn Rovers", "Stoke City",
                    "Swansea City", "Sheffield United", "Cardiff City", "Blackpool"
                ]
            },
            {
                name: "Ligue 1 2025-26",
                description: "France's top division - 20 elite clubs",
                teamCount: 20,
                teams: [
                    "Paris Saint-Germain", "Olympique Marseille", "AS Monaco", "Olympique Lyonnais",
                    "LOSC Lille", "AS Saint-Étienne", "Stade Rennais", "FC Nantes", "AJ Auxerre",
                    "Montpellier HSC", "OGC Nice", "Angers SCO", "Lens", "Strasbourg",
                    "Toulouse FC", "Reims", "Brest", "Le Havre", "Metz", "Clermont Foot"
                ]
            },
            {
                name: "Ligue 2 2025-26",
                description: "France's second division - 20 clubs competing for promotion",
                teamCount: 20,
                teams: [
                    "FC Nantes", "AS Saint-Étienne", "Angers SCO", "Pau FC", "Dijon FCO",
                    "Amiens SC", "ESTAC Troyes", "Red Star FC", "Dunkerque", "Grenoble Foot",
                    "Caen", "Paris FC", "Gazélec Ajaccio", "Laval", "Rodez AF",
                    "Châteauroux", "Quevilly-Rouen", "Niort", "Lorient", "Sochaux"
                ]
            }
        ];

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const { user } = await firebase.auth().signInWithEmailAndPassword(email, password);
                const tokenResult = await user.getIdTokenResult(true);

                if (!tokenResult.claims.admin) {
                    await firebase.auth().signOut();
                    throw new Error('Admin access required.');
                }

                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                startSignupFeed();
                errorDiv.classList.add('hidden');
            } catch (error) {
                errorDiv.textContent = 'Login failed: ' + error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        async function refreshTournaments() {
            const status = document.getElementById('status');
            const button = event.target;
            button.disabled = true;
            status.innerHTML = '<p class="text-blue-600">Refreshing tournaments...</p>';

            try {
                const manageTournaments = firebase.functions().httpsCallable('manageTournaments');
                const result = await manageTournaments({
                    action: 'refresh',
                    tournaments: tournamentData
                });

                status.innerHTML = '<p class="text-green-600 font-bold">✅ ' + result.data.message + '</p>';
                button.disabled = false;
            } catch (error) {
                status.innerHTML = '<p class="text-red-600">Error: ' + error.message + '</p>';
                button.disabled = false;
            }
        }

        async function logout() {
            if (signupUnsubscribe) {
                signupUnsubscribe();
                signupUnsubscribe = null;
            }
            await firebase.auth().signOut();
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }

        function startSignupFeed() {
            const summary = document.getElementById('signupSummary');
            const list = document.getElementById('signupList');

            if (signupUnsubscribe) {
                signupUnsubscribe();
                signupUnsubscribe = null;
            }

            signupUnsubscribe = db.collection('signupNotifications')
                .orderBy('createdAt', 'desc')
                .limit(20)
                .onSnapshot((snapshot) => {
                    summary.textContent = `${snapshot.size} recent signup${snapshot.size === 1 ? '' : 's'}`;

                    if (snapshot.empty) {
                        list.innerHTML = '<p class="text-sm text-gray-500">No signups yet.</p>';
                        return;
                    }

                    const items = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data() || {};
                        const when = data.createdAt && data.createdAt.toDate
                            ? data.createdAt.toDate().toLocaleString()
                            : 'Pending timestamp';
                        const name = data.displayName || data.email || data.uid || 'Unknown user';
                        const email = data.email ? ` · ${data.email}` : '';

                        items.push(`
                            <div class="border border-gray-200 rounded p-3 text-sm">
                                <div class="font-semibold text-gray-800">${name}</div>
                                <div class="text-gray-600">${when}${email}</div>
                            </div>
                        `);
                    });

                    list.innerHTML = items.join('');
                }, (error) => {
                    summary.textContent = 'Unable to load signup activity';
                    list.innerHTML = `<p class="text-sm text-red-600">${error.message}</p>`;
                });
        }

        // Check if already logged in
        firebase.auth().onAuthStateChanged(async user => {
            if (user) {
                try {
                    const tokenResult = await user.getIdTokenResult();
                    if (!tokenResult.claims.admin) {
                        document.getElementById('loginError').textContent = 'Admin access required.';
                        document.getElementById('loginError').classList.remove('hidden');
                        await logout();
                        return;
                    }

                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    startSignupFeed();
                } catch (error) {
                    document.getElementById('loginError').textContent = 'Admin verification failed: ' + error.message;
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } else if (signupUnsubscribe) {
                signupUnsubscribe();
                signupUnsubscribe = null;
            }
        });
    </script>
</body>
</html>
